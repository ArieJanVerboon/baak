<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyclades Birding Map</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin=""/>
    <style>
        /* Ensure html and body take full height */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0; /* Reset default padding */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f8ff; /* Light blue background */
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh; /* Ensure it fills the viewport */
            padding: 1rem; /* Keep padding for overall layout */
            box-sizing: border-box; /* Include padding in height calculation */
        }
        #map {
            height: 400px; /* Default height */
            width: 100%;
            max-width: 900px;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
            z-index: 0; /* Ensure map is behind cards if overlapping */
            /* Crucial Leaflet container styles */
            position: relative;
            overflow: hidden;
        }
        .info-card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            max-width: 900px;
            width: 100%;
            display: none; /* Hidden by default */
            position: relative;
            z-index: 10; /* Ensure card is above map */
            margin-bottom: 1.5rem;
        }
        .info-card.active {
            display: block;
        }
        .section-title {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            color: #2c5282; /* Darker blue for titles */
            margin-bottom: 1rem;
        }
        .bird-list-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            cursor: pointer; /* Make bird names clickable */
            transition: color 0.2s;
        }
        .bird-list-item:hover {
            color: #4a90e2; /* Highlight on hover */
        }
        /* Removed ::before for bird emoji as we are using image thumbnails now */
        /* .bird-list-item::before {
            content: 'üê¶';
            margin-right: 0.5rem;
            font-size: 1.2rem;
            flex-shrink: 0;
        } */
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: color 0.2s;
        }
        .close-button:hover {
            color: #333;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .thumbnail-image {
            width: 100%;
            height: 180px; /* Fixed height for consistency */
            object-fit: cover; /* Cover the area, cropping if necessary */
            border-radius: 1rem; /* Rounded corners for images */
            margin-bottom: 1rem;
            background-color: #e0e0e0; /* Placeholder background */
        }
        .bird-detail-thumbnail {
            width: 120px;
            height: 80px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin-right: 1rem;
            float: left; /* Float left to wrap text around it */
            margin-bottom: 0.5rem; /* Space below image */
        }
        .llm-details-container::after {
            content: "";
            display: table;
            clear: both; /* Clear float */
        }


        /* Responsive adjustments for map height */
        @media (min-width: 640px) {
            #map {
                height: 500px;
            }
        }
        @media (min-width: 768px) {
            #map {
                height: 600px;
            }
        }
    </style>
</head>
<body>

    <header class="w-full max-w-4xl text-center mb-8">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-800 mb-4 leading-tight">
            <span class="block text-6xl mb-2">üó∫Ô∏èüê¶</span>
            Birding Hotspots of the Cyclades
        </h1>
        <p class="text-lg text-gray-700">Click on the pins to discover prime birdwatching locations!</p>
    </header>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Info Card -->
    <div id="infoCard" class="info-card">
        <button class="close-button" onclick="hideInfoCard()">‚úñ</button>
        <img id="cardImage" class="thumbnail-image" alt="Location Thumbnail">
        <h2 id="cardTitle" class="section-title"></h2>
        <p id="cardDescription" class="text-gray-600 mb-4"></p>

        <h3 class="text-xl font-semibold text-blue-700 mb-3">Key Birding Areas:</h3>
        <ul id="cardKeyAreas" class="list-none pl-0 mb-4 grid grid-cols-1 sm:grid-cols-2 gap-2"></ul>

        <h3 class="text-xl font-semibold text-blue-700 mb-3">Notable Species:</h3>
        <ul id="cardNotableSpecies" class="list-none pl-0 grid grid-cols-1 sm:grid-cols-2 gap-2"></ul>

        <!-- LLM Generated Bird Details Section -->
        <div id="llmBirdDetails" class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200" style="display: none;">
            <h4 class="text-lg font-semibold text-blue-800 mb-2">‚ú® Bird Details ‚ú®</h4>
            <div class="llm-details-container">
                <img id="birdDetailImage" class="bird-detail-thumbnail" alt="Bird Thumbnail">
                <div id="llmBirdDetailsContent" class="text-gray-700"></div>
            </div>
            <div id="llmLoadingSpinner" class="hidden text-center mt-2">
                <div class="loading-spinner"></div> Loading details...
            </div>
        </div>
    </div>

    <footer class="w-full max-w-4xl text-center mt-auto text-gray-500 text-sm">
        <p>&copy; 2025 Cyclades Birding Map. Happy Birding!</p>
    </footer>

    <!-- Leaflet JS - This must load BEFORE your custom script -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        crossorigin=""></script>

    <!-- Custom Script - Placed after Leaflet JS to ensure L is defined -->
    <script>
        // Set the default path for Leaflet's marker icons immediately after Leaflet loads
        // This line MUST be executed AFTER leaflet.js has loaded.
        if (typeof L !== 'undefined') {
            L.Icon.Default.prototype.options.imagePath = 'https://unpkg.com/leaflet@1.9.4/dist/images/';
        } else {
            console.error("Leaflet (L) is not defined immediately after script load. Map may not display correctly.");
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            console.log('DOM Content Loaded. Initializing map...');

            const mapContainer = document.getElementById('map');

            // Robust check for map container dimensions before initializing Leaflet
            const checkMapContainerReady = () => {
                if (mapContainer && mapContainer.offsetWidth > 0 && mapContainer.offsetHeight > 0 && typeof L !== 'undefined') {
                    console.log('Map container is ready and Leaflet is defined. Proceeding with map initialization.');
                    initializeLeafletMap();
                } else {
                    console.log('Map container not yet ready or Leaflet not defined. Retrying in 50ms...');
                    // If L is not defined, display an error and stop retrying for map initialization
                    if (typeof L === 'undefined') {
                        console.error('Leaflet (L) is not defined. Cannot initialize map.');
                        if (mapContainer) {
                            mapContainer.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">Error loading map: Leaflet library not available. Please check your internet connection or try again later.</p>';
                            mapContainer.style.backgroundColor = '#ffe0e0';
                        }
                        return; // Stop retrying if L is definitively not there
                    }
                    setTimeout(checkMapContainerReady, 50); // Poll every 50ms
                }
            };

            const initializeLeafletMap = () => {
                try {
                    // Define a custom icon (optional, but good for consistency)
                    const customIcon = L.icon({
                        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                        iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
                        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    console.log('Custom Leaflet icon defined.');

                    // Initialize the map
                    const map = L.map('map').setView([37.00, 25.00], 9); // Centered around the Cyclades
                    console.log('Map object created.');

                    // Add OpenStreetMap tiles from a reliable provider (switched back to standard OSM)
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 19 // Standard max zoom for OpenStreetMap
                    }).addTo(map);
                    console.log('Tile layer added to map.');

                    // Force map size recalculation after a short delay
                    setTimeout(() => {
                        map.invalidateSize();
                        console.log('Map size invalidated after a short delay.');
                    }, 100); // 100ms delay

                    // Add listeners for map load and tile errors for debugging
                    map.on('load', function() {
                        console.log('Leaflet map has successfully loaded its tiles!');
                    });
                    map.on('tileerror', function(e) {
                        console.error('Error loading map tile:', e.tile.src, e);
                    });


                    // Birding locations data from the provided infographic
                    const locations = [
                        {
                            name: "Naxos: The Fertile Haven",
                            coords: [37.087, 25.405], // Approximate center of Naxos
                            description: "As the largest and most fertile island in the Cyclades, Naxos offers diverse habitats, from salt-pans to mountains, making it a prime destination for birdwatchers.",
                            keyAreas: [
                                "Salt-pans south of Hora (near Agios Prokopios)",
                                "Agia Anna (rocky jetty)",
                                "Mount Zas (highest peak)",
                                "Villages like Apeiranthos (for raptors)"
                            ],
                            notableSpecies: [
                                "Griffon Vulture", "Eleonora's Falcon", "Long-legged Buzzard", "Bonelli's Eagle",
                                "Peregrine Falcon", "Black-winged Stilt", "Stone Curlew", "Eastern Black-eared Wheatear",
                                "Ruppell's Warbler", "Cretzschmar's Bunting", "Scopoli's Shearwater", "Yelkouan Shearwater",
                                "Mediterranean Shag", "Blue Rock Thrush"
                            ],
                            locationImageUrl: "https://placehold.co/400x180/ADD8E6/000000?text=Naxos+Island"
                        },
                        {
                            name: "Syros: Migratory Hotspot",
                            coords: [37.443, 24.939], // Approximate center of Syros
                            description: "Syros, particularly its coastal areas like Poseidonia Bay, serves as an important resting and feeding ground for migratory birds during their long journeys.",
                            keyAreas: [
                                "Poseidonia Bay",
                                "Olive groves and coastal areas"
                            ],
                            notableSpecies: [
                                "Hoopoe", "Eleonora's Falcon", "Bonelli's Eagle (passage)", "Various Warblers",
                                "Shrikes", "Wheatears", "Flycatchers", "Swallows",
                                "Wagtails", "Gulls", "Shearwaters"
                            ],
                            locationImageUrl: "https://placehold.co/400x180/ADD8E6/000000?text=Syros+Island"
                        },
                        {
                            name: "Folegandros: Rocky Raptor Perch",
                            coords: [36.620, 24.900], // Approximate center of Folegandros
                            description: "This rugged island offers dramatic cliffs and rocky terrain, ideal for raptors and seabirds, especially during migration.",
                            keyAreas: [
                                "Cliffs and coastal areas",
                                "Inland rocky slopes"
                            ],
                            notableSpecies: [
                                "Bonelli's Eagle", "Rock Partridge", "Northern Wheatear", "Eleonora's Falcon",
                                "Yelkouan Shearwater", "Scopoli's Shearwater"
                            ],
                            locationImageUrl: "https://placehold.co/400x180/ADD8E6/000000?text=Folegandros+Cliffs"
                        },
                        {
                            name: "Milos: Wetland Wonders",
                            coords: [36.700, 24.450], // Approximate center of Milos
                            description: "Milos features important wetland areas and salt-pans, attracting a variety of waders and waterfowl, especially during migration periods.",
                            keyAreas: [
                                "Chivadolimni (salt-pan)",
                                "Milos airport pool",
                                "Klima area"
                            ],
                            notableSpecies: [
                                "Mallard", "Little Ringed Plover", "Little Stint", "Dunlin",
                                "Ruff", "Wood Sandpiper", "Audouin's Gull", "Moorhen",
                                "Honey Buzzard", "Shag"
                            ],
                            locationImageUrl: "https://placehold.co/400x180/ADD8E6/000000?text=Milos+Wetlands"
                        },
                        {
                            name: "Kea (Tzia): Oak Forest & Rich Fauna",
                            coords: [37.600, 24.330], // Approximate center of Kea
                            description: "Known for its significant oak forest, Kea provides a greener habitat compared to other Cycladic islands, supporting a diverse range of bird species.",
                            keyAreas: [
                                "Oak forests",
                                "Hilly areas and ravines",
                                "Coastal coves"
                            ],
                            notableSpecies: [
                                "Various Passerines", "Raptors (on passage)", "Warblers", "Flycatchers",
                                "Owls", "Crested Lark"
                            ],
                            locationImageUrl: "https://placehold.co/400x180/ADD8E6/000000?text=Kea+Oak+Forest"
                        }
                    ];

                    const infoCard = document.getElementById('infoCard');
                    const cardTitle = document.getElementById('cardTitle');
                    const cardDescription = document.getElementById('cardDescription');
                    const cardKeyAreas = document.getElementById('cardKeyAreas');
                    const cardNotableSpecies = document.getElementById('cardNotableSpecies');
                    const cardImage = document.getElementById('cardImage'); // New: for location image
                    const llmBirdDetails = document.getElementById('llmBirdDetails');
                    const llmBirdDetailsContent = document.getElementById('llmBirdDetailsContent');
                    const llmLoadingSpinner = document.getElementById('llmLoadingSpinner');
                    const birdDetailImage = document.getElementById('birdDetailImage'); // New: for bird image

                    // Function to show info card
                    window.showInfoCard = function(location) {
                        cardTitle.textContent = location.name;
                        cardDescription.textContent = location.description;
                        cardImage.src = location.locationImageUrl; // Set location image
                        cardImage.alt = location.name + " thumbnail";

                        // Clear previous lists
                        cardKeyAreas.innerHTML = '';
                        cardNotableSpecies.innerHTML = '';
                        llmBirdDetails.style.display = 'none'; // Hide LLM details when new card opens
                        llmBirdDetailsContent.innerHTML = ''; // Clear previous LLM content
                        birdDetailImage.src = ''; // Clear previous bird image

                        // Populate Key Birding Areas
                        location.keyAreas.forEach(area => {
                            const li = document.createElement('li');
                            li.className = 'bird-list-item';
                            li.textContent = area;
                            cardKeyAreas.appendChild(li);
                        });

                        // Populate Notable Species and make them clickable for LLM details
                        location.notableSpecies.forEach(species => {
                            const li = document.createElement('li');
                            li.className = 'bird-list-item';
                            li.textContent = species;
                            li.onclick = () => getBirdDetailsFromLLM(species); // Attach click handler
                            cardNotableSpecies.appendChild(li);
                        });

                        infoCard.classList.add('active');
                    }

                    // Function to hide info card
                    window.hideInfoCard = function() {
                        infoCard.classList.remove('active');
                        llmBirdDetails.style.display = 'none'; // Ensure LLM details are hidden on close
                        llmBirdDetailsContent.innerHTML = ''; // Clear LLM content
                        birdDetailImage.src = ''; // Clear bird image on close
                    }

                    // ‚ú® Gemini API Integration: Get Bird Details from LLM ‚ú®
                    async function getBirdDetailsFromLLM(birdName) {
                        llmBirdDetails.style.display = 'block'; // Show the LLM details section
                        llmBirdDetailsContent.innerHTML = ''; // Clear previous content
                        birdDetailImage.src = `https://placehold.co/120x80/ADD8E6/000000?text=${encodeURIComponent(birdName)}`; // Set bird-specific image
                        birdDetailImage.alt = birdName + " thumbnail";
                        llmLoadingSpinner.classList.remove('hidden'); // Show loading spinner

                        let chatHistory = [];
                        const prompt = `Provide a concise summary about the ${birdName} focusing on its typical habitat, diet, and one or two interesting facts. Keep it to about 80 words.`;
                        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                        const payload = { contents: chatHistory };
                        const apiKey = ""; // If you want to use models other than gemini-2.5-flash-preview-05-20 or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                        let retries = 0;
                        const maxRetries = 3;
                        const baseDelay = 1000; // 1 second

                        while (retries < maxRetries) {
                            try {
                                const response = await fetch(apiUrl, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload)
                                });

                                if (!response.ok) {
                                    // If response is not OK, throw an error to trigger retry
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }

                                const result = await response.json();

                                if (result.candidates && result.candidates.length > 0 &&
                                    result.candidates[0].content && result.candidates[0].content.parts &&
                                    result.candidates[0].content.parts.length > 0) {
                                    const text = result.candidates[0].content.parts[0].text;
                                    llmBirdDetailsContent.innerHTML = text;
                                    llmLoadingSpinner.classList.add('hidden'); // Hide spinner
                                    return; // Exit loop on success
                                } else {
                                    console.error("LLM response structure unexpected:", result);
                                    llmBirdDetailsContent.innerHTML = "Could not retrieve bird details. Please try again.";
                                    llmLoadingSpinner.classList.add('hidden'); // Hide spinner
                                    return; // Exit loop, as structure indicates a non-retryable issue
                                }
                            } catch (error) {
                                console.error("Error fetching LLM response:", error);
                                retries++;
                                if (retries < maxRetries) {
                                    const delay = baseDelay * Math.pow(2, retries - 1); // Exponential backoff
                                    console.log(`Retrying in ${delay / 1000} seconds... (Attempt ${retries + 1}/${maxRetries})`);
                                    await new Promise(resolve => setTimeout(resolve, delay));
                                } else {
                                    llmBirdDetailsContent.innerHTML = "Failed to retrieve bird details after multiple attempts. Please try again later.";
                                    llmLoadingSpinner.classList.add('hidden'); // Hide spinner
                                }
                            }
                        }
                    }

                    // Add markers for each location, using the custom icon
                    locations.forEach(location => {
                        const marker = L.marker(location.coords, { icon: customIcon }).addTo(map);
                        marker.bindPopup(`<b>${location.name.split(':')[0]}</b><br>Click for details!`);

                        marker.on('click', () => showInfoCard(location));
                    });
                    console.log('Markers added with custom icons.');

                    // Adjust map view on window resize for better responsiveness
                    window.addEventListener('resize', function() {
                        map.invalidateSize();
                    });
                    console.log('Resize listener added.');
                } catch (error) {
                    console.error('Error initializing Leaflet map:', error);
                    // Display a user-friendly message on the page
                    const mapContainer = document.getElementById('map');
                    if (mapContainer) {
                        mapContainer.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">Error loading map. Please try again later.</p>';
                        mapContainer.style.backgroundColor = '#ffe0e0'; // Light red background for error
                    }
                }
            };

            // Start the check for map container readiness and Leaflet definition
            checkMapContainerReady();
        }); // End of DOMContentLoaded
    </script>

</body>
</html>
